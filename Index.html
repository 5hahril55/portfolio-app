<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f2027">
<title>My Portfolio</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:white;
}

.container{
  padding:15px;
  max-width:1100px;
  margin:auto;
}

h2{text-align:center;}

.inputBox{
  display:flex;
  gap:10px;
  margin-bottom:15px;
}

input{
  flex:1;
  padding:12px;
  border-radius:10px;
  border:none;
  text-transform:uppercase;
}

button{
  padding:12px;
  border:none;
  border-radius:10px;
  background:#00c6ff;
  font-weight:bold;
  cursor:pointer;
}

.summary{
  background:white;
  color:black;
  padding:15px;
  border-radius:15px;
  margin-bottom:15px;
  text-align:center;
  font-weight:bold;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:14px;
}

.card{
  background:white;
  color:black;
  padding:15px;
  border-radius:15px;
  text-align:center;
  position:relative;
}

.remove{
  position:absolute;
  top:6px;
  right:10px;
  color:red;
  font-weight:bold;
  cursor:pointer;
}

.smallInput{
  width:45%;
  padding:6px;
  margin:6px 2px;
}

.green{color:green;}
.red{color:red;}
</style>
</head>

<body>

<div class="container">

<h2>ðŸ“Š My Portfolio</h2>

<div class="inputBox">
  <input id="ticker" placeholder="AAPL or BINANCE:BTCUSDT">
  <button onclick="addTicker()">Add</button>
</div>

<div class="summary" id="summary">
  Total Value: -- | Total P/L: -- | Total %: --
</div>

<div class="grid" id="grid"></div>

</div>

<script>

const FINNHUB_KEY = "d5t0s39r01qt62ngjap0d5t0s39r01qt62ngjapg";

let portfolio = JSON.parse(localStorage.getItem("portfolio")) || [];

function saveData(){
  localStorage.setItem("portfolio", JSON.stringify(portfolio));
}

function addTicker(){

  const input = document.getElementById("ticker");
  const ticker = input.value.trim().toUpperCase();

  if(!ticker || portfolio.find(p => p.ticker === ticker)) return;

  const obj = { ticker, entry:"", qty:"", price:0 };

  portfolio.push(obj);
  saveData();

  createCard(obj);
  fetchAllPrices();   // reload prices cleanly

  input.value="";
}

function createCard(item){

  const card = document.createElement("div");
  card.className = "card";
  card.id = item.ticker;

  card.innerHTML = `
    <div class="remove" onclick="removeTicker('${item.ticker}')">âœ–</div>
    <b>${item.ticker}</b>
    <div>Price: <span class="price">--</span></div>

    <input class="smallInput entry" type="text" placeholder="Entry" value="${item.entry}">
    <input class="smallInput qty" type="text" placeholder="Qty" value="${item.qty}">

    <div>Value: <span class="value">--</span></div>
    <div>P/L: <span class="pl">--</span></div>
    <div>P/L %: <span class="plp">--</span></div>
  `;

  document.getElementById("grid").appendChild(card);

  card.querySelector(".entry").addEventListener("input", () => updateData(item.ticker));
  card.querySelector(".qty").addEventListener("input", () => updateData(item.ticker));
}

function updateData(ticker){

  const card = document.getElementById(ticker);
  const index = portfolio.findIndex(p => p.ticker === ticker);

  portfolio[index].entry = card.querySelector(".entry").value;
  portfolio[index].qty   = card.querySelector(".qty").value;

  saveData();
  calculateAll();
}

function calculateAll(){

  let totalValue = 0;
  let totalCost = 0;

  portfolio.forEach(item => {

    const card = document.getElementById(item.ticker);
    if(!card) return;

    const price = Number(item.price);
    const entry = Number(item.entry);
    const qty   = Number(item.qty);

    if(!price || !entry || !qty){
      card.querySelector(".value").innerText = "--";
      card.querySelector(".pl").innerText = "--";
      card.querySelector(".plp").innerText = "--";
      return;
    }

    const value = price * qty;
    const cost = entry * qty;
    const pl = value - cost;
    const plp = (pl / cost) * 100;

    totalValue += value;
    totalCost += cost;

    card.querySelector(".value").innerText = value.toFixed(2);

    const plEl = card.querySelector(".pl");
    plEl.innerText = pl.toFixed(2);
    plEl.className = pl >= 0 ? "green" : "red";

    const plpEl = card.querySelector(".plp");
    plpEl.innerText = plp.toFixed(2) + "%";
    plpEl.className = plp >= 0 ? "green" : "red";

  });

  updateSummary(totalValue, totalCost);
}

function updateSummary(totalValue, totalCost){

  if(!totalValue || !totalCost){
    document.getElementById("summary").innerText =
      "Total Value: -- | Total P/L: -- | Total %: --";
    return;
  }

  const totalPL = totalValue - totalCost;
  const totalPLP = (totalPL / totalCost) * 100;

  const summary = document.getElementById("summary");

  summary.innerHTML = `
    Total Value: ${totalValue.toFixed(2)} |
    Total P/L: <span class="${totalPL>=0?'green':'red'}">${totalPL.toFixed(2)}</span> |
    Total %: <span class="${totalPLP>=0?'green':'red'}">${totalPLP.toFixed(2)}%</span>
  `;
}

async function fetchAllPrices(){

  await Promise.all(
    portfolio.map(async item => {

      const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${item.ticker}&token=${FINNHUB_KEY}`);
      const data = await res.json();

      if(data.c){
        item.price = data.c;

        const priceEl = document.querySelector(`#${item.ticker} .price`);
        if(priceEl){
          priceEl.innerText = data.c.toFixed(2);
        }
      }

    })
  );

  calculateAll();
}

function removeTicker(ticker){
  portfolio = portfolio.filter(p => p.ticker !== ticker);
  saveData();
  document.getElementById(ticker).remove();
  calculateAll();
}

document.getElementById("ticker").addEventListener("input", function(){
  this.value = this.value.toUpperCase();
});

portfolio.forEach(createCard);
fetchAllPrices();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
  
</script>

</body>
</html>